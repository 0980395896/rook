#cloud-config

coreos:
  etcd2:
    discovery: %%token%%
    advertise-client-urls: http://$public_ipv4:2379
    initial-advertise-peer-urls: http://$private_ipv4:2380
    listen-client-urls: http://0.0.0.0:2379,http://0.0.0.0:4001
    listen-peer-urls: http://$private_ipv4:2380,http://$private_ipv4:7001
  units:
  - name: etcd2.service
    command: start
  - name: castled.service
    enable: true
    command: start
# enable if you want to run from locally built ACI files
#    drop-ins:
#      - name: 10-local-aci.conf
#        content: |
#          [Service]
#          Environment=CASTLED_ACI=/release/quantum-castled-dev.aci
#          Environment=RKT_OPTIONS=--insecure-options=image
    content: |
      [Unit]
      Description=Castle Daemon - software defined storage
      Requires=network-online.target
      After=network-online.target

      [Service]
      Slice=machine.slice
      Restart=always
      KillMode=process

      Environment=CASTLED_ACI=quay.io/quantum/castled:latest
      Environment=CASTLED_ID=%m
      Environment=CASTLED_PUBLIC_IPV4=$public_ipv4
      Environment=CASTLED_PRIVATE_IPV4=$private_ipv4
      Environment=CASTLED_DATA_DIR=/var/lib/castled
      Environment=CASTLED_ETCD_MEMBERS=http://$public_ipv4:2379
      Environment=CASTLED_DATA_DEVICES=sda,sdb,sdc,sdd

      ExecStartPre=/usr/bin/mkdir -p ${CASTLED_DATA_DIR}

      ExecStart=/usr/bin/rkt run \
        --trust-keys-from-https \
        --stage1-from-dir=stage1-fly.aci \
        --inherit-env \
        --volume dns,kind=host,source=/run/systemd/resolve/resolv.conf,readOnly=true \
        --mount volume=dns,target=/etc/resolv.conf \
        --volume var-lib-castled,kind=host,source=/var/lib/castled \
        --mount volume=var-lib-castled,target=/var/lib/castled \
        $RKT_OPTIONS \
        $CASTLED_ACI

      [Install]
      WantedBy=multi-user.target

# temporary until we make the repo public.
write_files:
  - path: /etc/rkt/auth.d/quantum-demo-auth.json
    owner: root:root
    permissions: '0600'
    content: |
      {
        "rktKind": "auth",
        "rktVersion": "v1",
        "domains": [
          "quay.io"
        ],
        "type": "basic",
        "credentials": {
          "user": "quantum+demo",
          "password": "OD8HPMSRYOI5TU8ZWNXFHBXRM39HX4X7GB6MLW060SZ2W5DD04TEN5TCW3MHDNPO"
        }
      }
