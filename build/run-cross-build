#!/bin/bash -e

scriptdir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# git version 2.6.6+ through 2.8.3 had a bug with submodules
# see https://github.com/git/git/blob/master/Documentation/RelNotes/2.8.3.txt#L33
function ver { 
    printf "%d%03d%03d%03d" $(echo "$1" | tr '.' ' ') 
}
gitversion=$(git --version | cut -d" " -f3)
if (( $(ver ${gitversion}) > $(ver 2.6.6) && $(ver ${gitversion}) < $(ver 2.8.3) )); then
    echo WARN: your running git version ${gitversion} which has a bug realted to relative
    echo WARN: submodule paths. Please consider upgrading to 2.8.3 or later
fi

if [ -z $DOCKER_HOST ]; then
    USER_ARGS="-e BUILDER_UID=$( id -u ) -e BUILDER_GID=$( id -g ) -e BUILDER_USER=$( id -un ) -e BUILDER_GROUP=$( id -gn )"
    BUILDER_HOME=/home/$( id -un )
else
    BUILDER_HOME=/root
fi

if [ -n ${CCACHE_DIR+x} ]; then
    CCACHE_ARGS="-e CCACHE_DIR=${BUILDER_HOME}/.ccache -v ${CCACHE_DIR}:${BUILDER_HOME}/.ccache"
fi

[[ -f ${HOME}/.netrc ]] && NETRC_ARGS="-v ${HOME}/.netrc:${BUILDER_HOME}/.netrc"

tty -s && TTY_ARGS=-ti || TTY_ARGS=

arch=$1
shift

docker run \
    ${TTY_ARGS} \
    ${CCACHE_ARGS} \
    ${NETRC_ARGS} \
    ${USER_ARGS} \
    -v ${scriptdir}/..:${BUILDER_HOME}/castle \
    quantum/castle-build-${arch} \
    "$@"
